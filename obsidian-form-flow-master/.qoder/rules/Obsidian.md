---
trigger: always_on
alwaysApply: true
---

## 🎯 核心原则
**区分操作类型**：根据用户明确的操作意图执行相应规则，而非一刀切的禁止所有修改。

## 📋 操作类型分类规则

### 🔧 功能开发/维护操作 (用户明确要求时)
**允许的操作**：
- ✅ 添加新功能和特性
- ✅ 修复bug和错误
- ✅ 修改源代码逻辑
- ✅ 更新用户界面
- ✅ 调整配置选项
- ✅ 修改API接口
- ✅ 更新依赖版本
- ✅ 改进用户体验

**执行原则**：
- 按照用户的具体需求进行修改
- 确保新功能与现有功能协调
- 保持代码质量和最佳实践
- 提供清晰的修改说明

### 🚀 代码优化操作 (性能/结构优化)
**严格约束**：
- 🚫 **绝对禁止**改变任何现有功能的行为
- 🚫 **绝对禁止**修改用户界面的外观和交互
- 🚫 **绝对禁止**删除或修改现有配置选项
- 🚫 **绝对禁止**改变插件的对外API
- 🚫 **绝对禁止**破坏向后兼容性

**允许的操作**：
- ✅ 重构代码结构，提取公共函数
- ✅ 优化算法和性能
- ✅ 改进错误处理和类型安全
- ✅ 统一代码风格和命名
- ✅ 优化内存使用和异步处理
- ✅ 消除重复代码和死代码

### 🧹 项目精简操作 (文件清理)
**严格保护**：
- 🛡️ **必须保护**所有源代码文件
- 🛡️ **必须保护**Obsidian插件核心文件
- 🛡️ **必须保护**构建和配置文件
- 🛡️ **必须保护**任何被引用的文件

**允许删除**：
- ✅ 测试文件和测试目录
- ✅ 文档和示例文件
- ✅ 临时和缓存文件
- ✅ IDE配置文件
- ✅ CI/CD配置文件
- ✅ 未使用的资源文件

## 🔧 Obsidian插件开发专用规则

### 测试和调试规则
- 🚫 **禁止**添加浏览器测试相关代码和配置
- 🚫 **禁止**手动配置 sourcemap 相关设置
- 🚫 **禁止**添加浏览器环境的调试工具
- ✅ **依赖**用户在真实 Obsidian 环境中进行测试
- ✅ **信任** Obsidian 自动处理 sourcemap 的能力

### 调试信息管理规则
- 🔒 **强制要求**：所有调试信息输出必须有开关控制
- 📋 **实现方式**：
  - 在插件设置中添加"启用调试模式"开关
  - 所有 `console.log`、`console.warn`、`console.error` 等调试输出都必须检查调试开关
  - 调试信息应该分级别（info、warn、error、debug）
  - 生产环境默认关闭调试输出

**调试开关实现模板**：
```typescript
// 在设置中添加调试开关
interface PluginSettings {
    debugMode: boolean;
    // 其他设置...
}

// 在代码中使用调试开关
private debugLog(message: string, level: 'info' | 'warn' | 'error' | 'debug' = 'info') {
    if (this.settings.debugMode) {
        console[level](`[PluginName] ${message}`);
    }
}
```

### 代码扩展优先规则
- 🎯 **优先策略**：扩展现有代码而非创建新代码
- 📋 **执行原则**：
  - 分析现有函数和类的功能和结构
  - 评估是否可以通过参数扩展、方法重载、继承等方式扩展
  - 只有在现有代码架构完全不适用时才创建新的函数或类
  - 扩展时保持代码风格和命名约定的一致性
  - 确保扩展不会破坏现有功能

**代码扩展策略**：
1. **参数扩展**：为现有函数添加可选参数
2. **方法重载**：为现有方法添加不同的调用方式
3. **类继承**：扩展现有类而非创建新类
4. **接口扩展**：扩展现有接口定义
5. **配置扩展**：在现有配置对象中添加新选项

## 🔍 智能判断规则

### 操作意图识别
**当用户说**：
- "优化代码" / "重构项目" → 应用**代码优化规则**
- "精简项目" / "删除多余文件" → 应用**项目精简规则**
- "添加功能" / "修复bug" / "实现XXX" → 应用**功能开发规则**
- "修改界面" / "调整样式" → 应用**功能开发规则**

### 上下文感知
- **分析用户的具体需求**和操作背景
- **识别当前任务的主要目标**
- **根据操作类型选择对应的规则集**
- **在不确定时主动询问用户意图**

## ⚖️ 规则优先级

### 1. Obsidian插件专用规则 (最高优先级)
- 调试信息必须有开关控制
- 优先扩展现有代码而非创建新代码
- 不添加浏览器测试相关内容
- 不手动配置 sourcemap

### 2. 用户明确指令 (高优先级)
- 当用户明确要求修改某个功能时，遵循用户指令
- 当用户明确要求添加新特性时，按需求执行
- 当用户明确要求修复问题时，进行必要修改

### 3. 操作类型约束 (中等优先级)
- 在没有明确指令时，根据操作类型应用对应规则
- 优化操作时严格保护现有功能
- 精简操作时严格保护必要文件

### 4. 通用安全原则 (基础优先级)
- 始终确保项目可构建和运行
- 避免引入明显的错误和问题
- 保持代码质量和最佳实践

## 🤖 AI行为准则

### 主动确认机制
**当遇到以下情况时，主动询问用户**：
- 操作意图不明确时
- 可能影响现有功能时
- 需要删除重要文件时
- 修改可能有风险时
- 需要创建新函数或类而非扩展现有代码时

### 分阶段执行
1. **分析阶段**：理解用户需求和操作类型
2. **规划阶段**：制定符合对应规则的执行计划
3. **确认阶段**：向用户确认关键操作
4. **执行阶段**：按规则和计划执行操作
5. **验证阶段**：确保结果符合预期

### 透明化原则
- **明确说明**当前应用的规则集
- **详细解释**每个操作的原因和影响
- **主动报告**任何潜在的风险或限制
- **提供选择**让用户决定关键操作

## 📝 强制检查清单

### 每次代码修改后必须检查
- ✅ 所有调试输出是否有开关控制
- ✅ 是否优先扩展了现有代码而非创建新代码
- ✅ 是否避免了浏览器测试相关内容
- ✅ 是否避免了手动 sourcemap 配置
- ✅ 新功能是否与现有功能协调
- ✅ 代码风格是否保持一致

### 代码提交前验证
- ✅ 插件在 Obsidian 中可正常加载
- ✅ 所有新功能按预期工作
- ✅ 现有功能未受影响
- ✅ 调试开关正常工作
- ✅ 代码质量符合标准

---

**核心思想：根据用户的具体操作意图，智能选择和应用对应的规则集，同时严格遵守 Obsidian 插件开发的特殊要求，既保护项目完整性，又不阻碍正常的开发维护工作。**


